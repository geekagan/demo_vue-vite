name: Vue3+Vite项目打包部署到 git page - 配置2

on:
  push:
    branches:
      - main  # 当推送到 main 分支时触发

jobs:
  pnpm-build:
    name: 使用 pnpm 构建项目
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 安装 pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10
          run_install: false

      - name: 安装项目依赖
        run: pnpm install

      - name: 构建项目
        run: pnpm build

      - name: 创建归档文件
        run: |
          # mkdir -p dist # 创建一个用于打包的目录，可根据实际情况修改目录名
          # 将你的网页文件或其他静态资源复制到dist目录中，可根据实际情况修改命令
          # cp -r [你的source files] /dist
          tar -czvf github-pages.tar.gz -C dist . # 创建符合要求的tar.gz归档文件
          ls -al
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v4  # 上传 dist 到 GitHub 临时存储
        with:
          name: github-pages  # 工件名必须是 "github-pages"，不可修改
          path: ./github-pages.tar.gz      # 要上传的目录路径（Vite 构建默认输出到 dist）
          overwrite: true  # 覆盖同名文件

  deploy:
    name: 部署到 GitHub Pages
    needs: pnpm-build
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      pages: write
    environment: 
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}  # 部署后生成访问链接
    
    steps:      
      - name: 部署到 GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4  # GitHub 官方部署 Action（无需手动处理分支）
        with:
          artifact_name: github-pages
